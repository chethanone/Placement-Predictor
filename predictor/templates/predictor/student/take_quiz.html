{% extends 'predictor/base.html' %}

{% block content %}
<style>
 * {
 font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
 }
 
 :root {
 --sage-green: #8FB9A8;
 --cream: #FEFAD4;
 --peach: #FCB9AA;
 --rose: #F1828D;
 --mauve: #765D69;
 }
 
 body {
 background: linear-gradient(135deg, #e8f5f1 0%, #f5e6f3 100%);
 min-height: 100vh;
 padding-bottom: 80px !important;
 }
 
 /* Hide error messages on quiz page */
 .messages-container,
 .alert,
 .messages-container .alert {
 display: none !important;
 visibility: hidden !important;
 height: 0 !important;
 margin: 0 !important;
 padding: 0 !important;
 overflow: hidden !important;
 }
 
 /* Ensure footer doesn't overlap */
 .footer {
 margin-top: 80px !important;
 position: relative !important;
 }
 
 /* Ensure main content has proper spacing */
 .main-content {
 padding-bottom: 100px !important;
 }
 
 .quiz-wrapper {
 max-width: 1000px;
 margin: 0 auto;
 padding: 20px;
 padding-top: 120px;
 padding-bottom: 60px;
 }
 
 .quiz-header {
 background: linear-gradient(135deg, var(--sage-green) 0%, #7aa697 100%);
 color: white;
 padding: 35px 40px;
 border-radius: 20px;
 margin-bottom: 30px;
 box-shadow: 0 10px 40px rgba(143, 185, 168, 0.3);
 }
 
 .quiz-header h1 {
 margin: 0 0 10px 0;
 font-size: 2.2rem;
 font-weight: 700;
 color: white;
 }
 
 .quiz-header p {
 margin: 0 0 20px 0;
 opacity: 0.95;
 font-size: 1.05rem;
 }
 
 .quiz-info {
 display: flex;
 gap: 15px;
 margin-top: 20px;
 flex-wrap: wrap;
 }
 
 .quiz-info-item {
 background: rgba(255,255,255,0.25);
 padding: 10px 18px;
 border-radius: 12px;
 backdrop-filter: blur(10px);
 font-size: 0.95rem;
 }
 
 .quiz-info-item strong {
 font-weight: 600;
 }
 
 .progress-section {
 background: white;
 padding: 25px 30px;
 border-radius: 16px;
 margin-bottom: 25px;
 box-shadow: 0 4px 15px rgba(0,0,0,0.08);
 }
 
 .progress-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 15px;
 }
 
 .progress-header h3 {
 margin: 0;
 color: var(--mauve);
 font-size: 1.1rem;
 font-weight: 600;
 }
 
 .progress-count {
 color: var(--sage-green);
 font-weight: 600;
 font-size: 1rem;
 }
 
 .progress-bar-container {
 background: #e8e8e8;
 height: 12px;
 border-radius: 12px;
 overflow: hidden;
 }
 
 .progress-bar {
 height: 100%;
 background: linear-gradient(90deg, var(--sage-green), var(--peach));
 width: 0%;
 transition: width 0.4s ease;
 border-radius: 12px;
 }
 
 .question-container {
 background: white;
 border-radius: 20px;
 padding: 40px;
 box-shadow: 0 8px 30px rgba(0,0,0,0.1);
 border: 3px solid var(--cream);
 min-height: 400px;
 position: relative;
 }
 
 .question-card {
 display: none;
 }
 
 .question-card.active {
 display: block;
 animation: fadeIn 0.4s ease;
 }
 
 @keyframes fadeIn {
 from {
 opacity: 0;
 transform: translateY(10px);
 }
 to {
 opacity: 1;
 transform: translateY(0);
 }
 }
 
 .question-number {
 background: var(--mauve);
 color: white;
 padding: 8px 20px;
 border-radius: 25px;
 font-size: 0.95rem;
 font-weight: 600;
 display: inline-block;
 margin-bottom: 20px;
 }
 
 .question-text {
 font-size: 1.3rem;
 color: #2c3e50;
 margin-bottom: 30px;
 line-height: 1.7;
 font-weight: 500;
 }
 
 .options-container {
 display: flex;
 flex-direction: column;
 gap: 15px;
 margin-bottom: 30px;
 }
 
 .option-label {
 display: flex;
 align-items: center;
 padding: 18px 24px;
 background: #fafafa;
 border: 2px solid #e0e0e0;
 border-radius: 14px;
 cursor: pointer;
 transition: all 0.3s ease;
 font-size: 1.05rem;
 color: #333;
 }
 
 .option-label:hover {
 background: var(--cream);
 border-color: var(--sage-green);
 transform: translateX(8px);
 }
 
 .option-label input[type="radio"] {
 margin-right: 18px;
 width: 22px;
 height: 22px;
 cursor: pointer;
 accent-color: var(--sage-green);
 }
 
 .option-label.selected {
 background: var(--cream);
 border-color: var(--sage-green);
 border-width: 3px;
 }
 
 .option-label.selected span {
 font-weight: 600;
 color: var(--mauve);
 }
 
 .text-answer {
 width: 100%;
 padding: 18px 20px;
 border: 2px solid #e0e0e0;
 border-radius: 14px;
 font-size: 1.05rem;
 font-family: 'Inter', sans-serif;
 transition: all 0.3s ease;
 resize: vertical;
 min-height: 120px;
 color: #333;
 }
 
 .text-answer:focus {
 outline: none;
 border-color: var(--sage-green);
 border-width: 3px;
 box-shadow: 0 0 0 4px rgba(143, 185, 168, 0.15);
 }
 
 .short-answer {
 min-height: 60px;
 }
 
 .navigation-buttons {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-top: 40px;
 gap: 15px;
 }
 
 .nav-btn {
 padding: 15px 40px;
 border: none;
 border-radius: 12px;
 font-size: 1.1rem;
 font-weight: 600;
 cursor: pointer;
 transition: all 0.3s ease;
 font-family: 'Inter', sans-serif;
 }
 
 .prev-btn {
 background: #f0f0f0;
 color: var(--mauve);
 border: 2px solid #e0e0e0;
 }
 
 .prev-btn:hover:not(:disabled) {
 background: #e8e8e8;
 transform: translateX(-5px);
 }
 
 .prev-btn:disabled {
 opacity: 0.4;
 cursor: not-allowed;
 }
 
 .next-btn {
 background: linear-gradient(135deg, var(--sage-green), #7aa697);
 color: white;
 box-shadow: 0 6px 20px rgba(143, 185, 168, 0.4);
 }
 
 .next-btn:hover:not(:disabled) {
 transform: translateX(5px);
 box-shadow: 0 8px 25px rgba(143, 185, 168, 0.5);
 }
 
 .next-btn:disabled {
 opacity: 0.5;
 cursor: not-allowed;
 }
 
 .submit-btn {
 background: linear-gradient(135deg, var(--rose), #e86f7a);
 color: white;
 padding: 16px 50px;
 border: none;
 border-radius: 12px;
 font-size: 1.2rem;
 font-weight: 700;
 cursor: pointer;
 transition: all 0.3s ease;
 box-shadow: 0 8px 25px rgba(241, 130, 141, 0.4);
 font-family: 'Inter', sans-serif;
 }
 
 .submit-btn:hover {
 transform: translateY(-3px);
 box-shadow: 0 12px 35px rgba(241, 130, 141, 0.6);
 }
 
 .final-submit-container {
 background: white;
 padding: 60px 40px;
 border-radius: 20px;
 box-shadow: 0 8px 30px rgba(0,0,0,0.1);
 border: 3px solid var(--cream);
 text-align: center;
 }
 
 .final-submit-container h2 {
 color: var(--mauve);
 margin-bottom: 15px;
 font-size: 1.8rem;
 }
 
 .final-submit-container p {
 color: #666;
 margin-bottom: 30px;
 font-size: 1.1rem;
 }
 
 @media (max-width: 768px) {
 .quiz-wrapper {
 padding: 15px;
 padding-top: 100px;
 padding-bottom: 40px;
 }
 
 .question-container {
 padding: 25px;
 }
 
 .navigation-buttons {
 flex-direction: column;
 }
 
 .nav-btn {
 width: 100%;
 }
 
 .final-submit-container {
 padding: 40px 25px;
 }
 }
</style>

<div class="quiz-wrapper">
 <div class="quiz-header">
 <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
 <h1 style="margin: 0;"><i class="fas fa-edit"></i> Take Quiz</h1>
 <button type="button" onclick="confirmQuit()" style="background: rgba(255,255,255,0.25); color: white; padding: 10px 20px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);">
 <i class="fas fa-times-circle"></i> Quit Quiz
 </button>
 </div>
 <p>Answer all questions to complete the quiz and get your results</p>
 <div class="quiz-info">
 <div class="quiz-info-item">
 <strong>Total Questions:</strong> {{ questions|length }}
 </div>
 <div class="quiz-info-item">
 <strong>File:</strong> {{ quiz.uploaded_file.name|default:"Study Material" }}
 </div>
 <div class="quiz-info-item">
 <strong>Status:</strong> {{ quiz.status|title }}
 </div>
 </div>
 </div>
 
 <div class="progress-section">
 <div class="progress-header">
 <h3>Your Progress</h3>
 <span class="progress-count">
 <span id="currentQuestion">1</span> / {{ questions|length }}
 </span>
 </div>
 <div class="progress-bar-container">
 <div class="progress-bar" id="progressBar"></div>
 </div>
 </div>
 
 <form method="post" action="{% url 'student_submit_quiz' quiz.id %}" id="quizForm">
 {% csrf_token %}
 
 <div class="question-container">
 {% for question in questions %}
 <div class="question-card" data-question-index="{{ forloop.counter0 }}" data-question-id="{{ question.id }}">
 <div class="question-number">Question {{ forloop.counter }} of {{ questions|length }}</div>
 <div class="question-text">
 {{ question.question_text }}
 {% if 'figure' in question.question_text|lower or 'fig.' in question.question_text|lower or 'diagram' in question.question_text|lower or 'graph' in question.question_text|lower or 'chart' in question.question_text|lower or 'table' in question.question_text|lower %}
 <div style="margin-top: 12px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px; font-size: 14px; color: #856404;">
 <strong><i class="fas fa-chart-pie" style="margin-right: 6px;"></i>Note:</strong> This question references a visual element from the original document. Please refer to your study material for the complete context.
 </div>
 {% endif %}
 </div>
 
 {% if question.question_type == 'mcq' %}
 <div class="options-container">
 {% load custom_filters %}
 {% with options=question.options|parse_json %}
 {% for option in options %}
 <label class="option-label">
 <input type="radio" 
 name="question_{{ question.id }}" 
 value="{{ option }}"
 onchange="handleAnswer(this)"
 required>
 <span>{{ option }}</span>
 </label>
 {% endfor %}
 {% endwith %}
 </div>
 
 {% elif question.question_type == 'true_false' or question.question_type == 'tf' %}
 <div class="options-container">
 <label class="option-label">
 <input type="radio" 
 name="question_{{ question.id }}" 
 value="True"
 onchange="handleAnswer(this)"
 required>
 <span>True</span>
 </label>
 <label class="option-label">
 <input type="radio" 
 name="question_{{ question.id }}" 
 value="False"
 onchange="handleAnswer(this)"
 required>
 <span>False</span>
 </label>
 </div>
 
 {% elif question.question_type == 'fill_blank' %}
 <input type="text" 
 name="question_{{ question.id }}" 
 class="text-answer short-answer"
 placeholder="Type your answer here..."
 oninput="handleAnswer(this)"
 required>
 
 {% elif question.question_type == 'short_answer' %}
 <textarea name="question_{{ question.id }}" 
 class="text-answer"
 placeholder="Type your answer here..."
 oninput="handleAnswer(this)"
 required></textarea>
 {% endif %}
 
 <div class="navigation-buttons">
 <button type="button" class="nav-btn prev-btn" onclick="previousQuestion()">
 ← Previous
 </button>
 <button type="button" class="nav-btn next-btn" onclick="nextQuestion()">
 Next →
 </button>
 </div>
 </div>
 {% endfor %}
 </div>
 
 <div class="final-submit-container" style="display: none;">
                     <h2><i class="fas fa-check-circle"></i> Quiz Completed!</h2>
 <p>You've answered all {{ questions|length }} questions. Review your answers or submit the quiz.</p>
 <div class="navigation-buttons" style="justify-content: center; margin-bottom: 20px;">
 <button type="button" class="nav-btn prev-btn" onclick="previousQuestion()">
 ← Review Answers
 </button>
 </div>
 <button type="submit" class="submit-btn" id="submitBtn">
 <i class="fas fa-paper-plane"></i> Submit Quiz
 </button>
 </div>
 </form>
</div>

<script>
 let currentQuestionIndex = 0;
 const totalQuestions = {{ questions|length }};
 const answeredQuestions = new Set();
 
 // Question IDs array
 const questionIds = [
 {% for question in questions %}
 {{ question.id }}{% if not forloop.last %},{% endif %}
 {% endfor %}
 ];
 
 function showQuestion(index) {
 // Hide all questions
 document.querySelectorAll('.question-card').forEach(card => {
 card.classList.remove('active');
 });
 
 // Show current question
 const currentCard = document.querySelector(`[data-question-index="${index}"]`);
 if (currentCard) {
 currentCard.classList.add('active');
 }
 
 // Update progress
 updateProgress();
 
 // Update navigation buttons
 updateNavigationButtons();
 
 // Don't scroll - removed the annoying auto-scroll
 }
 
 function nextQuestion() {
 if (currentQuestionIndex < totalQuestions - 1) {
 currentQuestionIndex++;
 showQuestion(currentQuestionIndex);
 } else if (currentQuestionIndex === totalQuestions - 1) {
 // Moving from last question to submit screen
 if (!checkAllAnswered()) {
 highlightUnansweredQuestions();
 alert(`Please answer all questions before proceeding. You have answered ${answeredQuestions.size} out of ${totalQuestions} questions.`);
 return;
 }
 currentQuestionIndex++;
 showQuestion(currentQuestionIndex);
 }
 }
 
 function previousQuestion() {
 if (currentQuestionIndex > 0) {
 currentQuestionIndex--;
 showQuestion(currentQuestionIndex);
 }
 }
 
 function updateNavigationButtons() {
 const prevBtns = document.querySelectorAll('.prev-btn');
 const nextBtns = document.querySelectorAll('.next-btn');
 const submitContainer = document.querySelector('.final-submit-container');
 const questionContainer = document.querySelector('.question-container');
 
 // Update all Previous buttons
 prevBtns.forEach(btn => {
 btn.disabled = currentQuestionIndex === 0;
 });
 
 // Always show next buttons on all questions
 nextBtns.forEach(btn => {
 btn.style.display = 'block';
 });
 
 // Show submit button only after going past last question
 if (currentQuestionIndex === totalQuestions) {
 questionContainer.style.display = 'none';
 submitContainer.style.display = 'block';
 } else {
 questionContainer.style.display = 'block';
 submitContainer.style.display = 'none';
 }
 }
 
 function handleAnswer(element) {
 const questionCard = element.closest('.question-card');
 const questionId = questionCard.dataset.questionId;
 
 // Mark question as answered
 answeredQuestions.add(parseInt(questionId));
 
 // Update selected state for radio buttons
 if (element.type === 'radio') {
 questionCard.querySelectorAll('.option-label').forEach(label => {
 label.classList.remove('selected');
 });
 element.closest('.option-label').classList.add('selected');
 }
 
 updateProgress();
 }
 
 function updateProgress() {
 const percentage = (answeredQuestions.size / totalQuestions) * 100;
 document.getElementById('progressBar').style.width = percentage + '%';
 // Fix: Don't show 26/25, cap at totalQuestions
 const displayQuestion = Math.min(currentQuestionIndex + 1, totalQuestions);
 document.getElementById('currentQuestion').textContent = displayQuestion;
 }
 
 function highlightUnansweredQuestions() {
 document.querySelectorAll('.question-card').forEach(card => {
 const questionId = parseInt(card.dataset.questionId);
 if (!answeredQuestions.has(questionId)) {
 card.style.borderLeft = '5px solid #ff4444';
 card.style.backgroundColor = '#fff5f5';
 } else {
 card.style.borderLeft = '5px solid var(--peach)';
 card.style.backgroundColor = 'white';
 }
 });
 }
 
 function checkAllAnswered() {
 const form = document.getElementById('quizForm');
 const formData = new FormData(form);
 let allAnswered = true;
 
 questionIds.forEach(id => {
 const answer = formData.get('question_' + id);
 if (!answer || answer.trim() === '') {
 allAnswered = false;
 }
 });
 
 return allAnswered;
 }
 
 // Form submission
 document.getElementById('quizForm').addEventListener('submit', function(e) {
 if (!checkAllAnswered()) {
 e.preventDefault();
 alert(`Please answer all questions before submitting. You have answered ${answeredQuestions.size} out of ${totalQuestions} questions.`);
 return false;
 }
 
 if (!confirm('Are you sure you want to submit your quiz? You cannot change your answers after submission.')) {
 e.preventDefault();
 return false;
 }
 
 const submitBtn = document.getElementById('submitBtn');
 submitBtn.textContent = 'Submitting... Please wait ⏳';
 submitBtn.disabled = true;
 });
 
 // Check for existing answers on page load
 window.addEventListener('DOMContentLoaded', function() {
 showQuestion(0);
 
 // Check for pre-filled answers
 questionIds.forEach(id => {
 const input = document.querySelector(`[name="question_${id}"]`);
 if (input) {
 if (input.type === 'radio') {
 const checked = document.querySelector(`[name="question_${id}"]:checked`);
 if (checked) {
 answeredQuestions.add(id);
 checked.closest('.option-label').classList.add('selected');
 }
 } else if (input.value && input.value.trim() !== '') {
 answeredQuestions.add(id);
 }
 }
 });
 
 updateProgress();
 });
 
 // Add Enter key navigation
 document.addEventListener('keydown', function(e) {
 if (e.key === 'Enter') {
 // Don't trigger on textarea
 if (e.target.tagName.toLowerCase() === 'textarea') {
 return;
 }
 
 e.preventDefault();
 
 // If on last question, move to submit screen (with validation)
 if (currentQuestionIndex === totalQuestions - 1) {
 if (!checkAllAnswered()) {
 highlightUnansweredQuestions();
 alert(`Please answer all questions before proceeding. You have answered ${answeredQuestions.size} out of ${totalQuestions} questions.`);
 return;
 }
 currentQuestionIndex++;
 updateNavigationButtons();
 } 
 // Otherwise go to next question
 else if (currentQuestionIndex < totalQuestions - 1) {
 nextQuestion();
 }
 }
 });

 // Quit quiz with confirmation
 function confirmQuit() {
 if (confirm('Are you sure you want to quit?\n\nYour progress will NOT be saved and you will return to the Student Portal.')) {
 window.location.href = "{% url 'student_portal' %}";
 }
 }
</script>

{% endblock %}
